<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ניהול שוברים</title>

    <!-- ##################################################################################### -->
    <!-- #####################################   Style   ##################################### -->
    <!-- ##################################################################################### -->
    <style>
        * {
            margin:0; padding:0; box-sizing:border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --clr-grn0: #465236;
            --clr-grn1: #6e8352;
            --clr-grn2: #97AA7C;
            --clr-grn3: #B7C7A0;
            --clr-grn4: #dfe7cd;
            --clr-grn5: #eee9df;
            --clr-grn6: #8b9a8b;
            --clr-grn7: #c0cbb8;
            --clr-gry1: #333;
            --clr-gry3: #777;
            --clr-gry2: #888;
            --clr-gry5: #e0dcdc;
            --clr-red: #c17a7a;
        }
    
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            background: var(--clr-grn5);
            color: var(--clr-gey1);
            min-height: 100vh;
            padding-bottom: 100px;
        }

        .container { max-width: 500px; margin: 0 auto; }

        .header {
            background: var(--clr-grn5);
            padding: 12px;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 1px solid var(--clr-gry5);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .header h1 {
            margin: 0 0 10px 0;
            font-size: 24px;
            text-align: center;
            color: var(--clr-grn0);
        }

        .tabs { display:flex; gap:10px; }

        .tab-btn {
            flex:1;
            padding:8px;
            background: var(--clr-grn5);
            border-radius: 8px;
            border: 1px solid var(--clr-grn2);
            box-sizing:content-box;
            cursor: pointer;
            font-size: 15px;
            color: var(--clr-grn0);
            transition: 0.2s;
        }

        .tab-btn.active {
            background: var(--clr-grn2);
            font-weight: bold;
        }

        .content { padding: 10px; }

        .voucher-item {
            background: var(--clr-grn4);
            border-radius: 12px;
            padding: 8px 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: grid;
            grid-template-columns: 1fr auto;
            grid-template-rows: auto auto;
            gap: 6px 12px;
            align-items: start;
        }

        .voucher-item.redeemed {
            opacity: 0.5;
        }

        .voucher-name {
            font-weight: bold;
            font-size: 16px;
            color: var(--clr-gry1);
            grid-column: 1;
            grid-row: 1;
        }

        .voucher-balance {
            font-size: 18px;
            color: var(--clr-grn1);
            font-weight: bold;
            grid-column: 2;
            grid-row: 1;
            text-align: left;
        }

        .voucher-code {
            font-size: 16px;
            color: var(--clr-grn1);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            grid-column: 2;
            grid-row: 2;
            text-align: left;
            direction: ltr; 
        }

        .voucher-redeemed-badge {
            display: inline-block;
            background: var(--clr-grn2);
            color: white;
            padding: 0px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            grid-column: 1;
            grid-row: 2;
            align-self: start;
            width: fit-content;
            align-items: center;
            white-space: nowrap;
            font-style: italic;
        }

        .ban-icon {
            width: 14px;
            height: 14px;
            vertical-align: middle;
            margin-bottom: 2px;
            margin-left: 2px;
        }

        .bottom-actions {
            position: fixed;
            bottom:0;
            left:50%;
            transform: translateX(-50%);
            max-width:500px;
            width:100%;
            background: var(--clr-grn5);
            padding:12px;
            border-top:1px solid var(--clr-gry5);
            display:flex;
            gap:10px;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.05);
        }

        .action-btn {
            flex:1;
            padding:10px;
            border:none;
            border-radius:8px;
            background: var(--clr-grn1);
            color: white;
            cursor:pointer;
            font-size:14px;
            display:flex;
            align-items:center;
            justify-content:space-evenly;
            transition: 0.2s;
        }

        .action-btn svg {
            width: 20px;
            height: 20px;
        }

        .action-btn.btn-more {flex:0.5;}

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items:start;
            justify-content:center;
            padding:20px;
            z-index:1000;
        }

        .modal-overlay.active { display:flex; }

        .modal-card {
            background: var(--clr-grn4);
            border-radius: 12px;
            padding: 20px;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        #modal-title {
            margin: 0;
            font-size: 18px;
            color: var(--clr-grn0);
        }

        .modal-menu-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 4px;
            color: var(--clr-grn1);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            transition: 0.2s;
            position: relative;
        }

        .modal-menu-btn:hover {background: rgba(139, 154, 139, 0.2);}

        .modal-menu-btn svg {
            width: 20px;
            height: 20px;
        }

        .modal-menu-btn.hidden {visibility: hidden;}

        .modal-menu-popup {
            position: absolute;
            top: 34px;
            left: 0;
            background: var(--clr-grn4);
            border: 1px solid var(--clr-grn2);
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            z-index: 1001;
            min-width: 150px;
            display: none;
        }

        .modal-menu-popup.active {display: block;}

        .modal-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            color: var(--clr-grn0);
            font-size: 15px;
            transition: 0.2s;
            text-align: right;
        }

        .modal-menu-item:hover {background: rgba(139, 154, 139, 0.3);}
        .modal-menu-item:first-child {border-radius: 8px 8px 0 0;}
        .modal-menu-item:last-child {border-radius: 0 0 8px 8px;}

        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
        }

        .form-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-bottom: 8px;
        }

        .form-group.value-group {
            flex: 0.7;
        }

        .form-group.in-row {
            margin-bottom: 0;
        }

        label {
            display: block;
            color: var(--clr-grn0);
            margin-bottom: 3px;
            font-size: 14px;
            text-align: right;
        }

        input, textarea {
            width: 100%;
            padding: 6px;
            background: rgba(139, 154, 139, 0.3);
            border: 1px solid #b4beb4;
            border-radius: 6px;
            font-size: 15px;
            color: var(--clr-grn0);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            direction: rtl;
            text-align: right;
        }

        input::placeholder, textarea::placeholder {
            color: var(--clr-gry3);
            opacity: 0.7;
        }

        textarea {
            min-height: 20px;
            resize: vertical;
        }

        .redemptions-box {
            border: 1px solid var(--clr-grn1);
            border-radius: 8px;
            padding: 8px;
            margin: 15px 0;
            min-height: 90px;
            max-height: 200px;
            overflow: hidden;
            overflow-y: auto;
        }

        .redemption-input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
        }

        .add-redemption-btn {
            background-color: var(--clr-grn1);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            white-space: nowrap;
        }

        .redemption-item {
            background-color: rgba(139, 154, 139, 0.3);
            border-radius: 6px;
            padding: 4px 8px;
            margin-bottom: 3px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 15px;
            color: var(--clr-gry1);
        }

        .redemption-item .date {
            margin-left: auto;
        }

        .redemption-item button {
            margin-right: 3px;
            margin-left: 10px;
        }

        .delete-btn {
            background-color: transparent;
            border: none;
            color: var(--clr-gry1);
            font-size: 15px;
            cursor: pointer;
            align-self: flex-end;
        }

        .balance-box {
            border: 1px solid var(--clr-grn1);
            border-radius: 8px;
            padding: 6px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex: 2;
            background: rgba(139, 154, 139, 0.1);
        }

        .balance-label {
            font-weight: bold;
            font-size: 16px;
            color: var(--clr-grn0);
        }

        .balance-amount {
            font-weight: bold;
            font-size: 18px;
            color: var(--clr-grn0);
        }

        .button-row {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            border: none;
            border-radius: 8px;
            padding: 10px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }

        .btn-cancel {
            background-color: var(--clr-grn6);
        }

        .btn-mark-used {
            background-color: var(--clr-grn1);
            flex: 1;
            padding: 5px;
        }

        .btn-mark-used.used {
            background-color: var(--clr-grn3);
        }

        .btn-save {
            background-color: var(--clr-grn1);
        }

        .btn-delete {
            background-color: var(--clr-red);
        }

        .modal-card::-webkit-scrollbar {
            width: 8px;
        }

        .modal-card::-webkit-scrollbar-track {
            background: rgba(139, 154, 139, 0.2);
            border-radius: 10px;
        }

        .modal-card::-webkit-scrollbar-thumb {
            background: var(--clr-grn2);
            border-radius: 10px;
        }

        .empty-state { 
            text-align:center; 
            padding:40px 20px; 
            color:var(--clr-grn2); 
        }

        .modal {
            background: var(--clr-grn5);
            border-radius:12px;
            padding:20px;
            width:100%;
            max-width:400px;
            max-height:90vh;
            overflow:auto;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .modal h2 { 
            margin:0 0 20px 0; 
            font-size:20px; 
            color:var(--clr-grn0); 
        }

        .search-results .voucher-item { 
            padding: 10px 12px; 
        }

        .modal-more-actions {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .modal-more-actions .modal-btn {
            width: 100%;
        }

        .modal-more-actions .modal-btn.btn-cancel {
            margin-top: 20px;
        }
        
        .modal-more-actions .action-group {
            display: flex;
            flex-direction: row;
            gap: 10px;
            width: 100%;
            padding: 20px 0;
            margin: 20px 0;
            border-top: 1px solid var(--clr-gry5);
            border-bottom: 1px solid var(--clr-gry5);
        }

        .modal-more-actions .action-group .modal-btn {
            border: 2px solid var(--clr-grn1);
            color: var(--clr-grn1);
            background-color: transparent;
        }

        .modal-more-actions .action-group .modal-btn.btn-delete {
            border-color: var(--clr-red);
            color: var(--clr-red);
            background-color: transparent;
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.3);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-overlay.active { display: flex; }

        .loading-spinner {
            border: 4px solid var(--clr-grn4);
            border-top: 4px solid var(--clr-grn1);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <svg style="display:none;">
        <symbol id="icon-circle-plus" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <path d="M8 12h8"/>
            <path d="M12 8v8"/>
        </symbol>
        <symbol id="icon-search" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m21 21-4.34-4.34"/>
            <circle cx="11" cy="11" r="8"/>
        </symbol>
        <symbol id="icon-ticket" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/>
            <path d="M13 5v2"/><path d="M13 17v2"/><path d="M13 11v2"/>
        </symbol>
        <symbol id="icon-ellipsis" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="17" r="1"/><circle cx="19" cy="17" r="1"/><circle cx="5" cy="17" r="1"/>
        </symbol>
        <symbol id="icon-chevron-left" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m15 18-6-6 6-6"/>
        </symbol>
        <symbol id="icon-ban" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4.929 4.929 19.07 19.071" />
            <circle cx="12" cy="12" r="10" />
        </symbol>
        <symbol id="icon-shopping-cart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="8" cy="21" r="1"/>
            <circle cx="19" cy="21" r="1"/>
            <path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/>
        </symbol>
    </svg>

    <!-- ##################################################################################### -->
    <!-- #####################################   Body    ##################################### -->
    <!-- ##################################################################################### -->
    <div class="container">
        <div class="header">
            <h1>ניהול שוברים</h1>
            <div class="tabs">
                <button class="tab-btn active" onclick="showActiveVouchers(true)">
                    שוברים פעילים (<span id="active-count">0</span>)
                </button>
                <button class="tab-btn" onclick="showActiveVouchers(false)">
                    שוברים לא פעילים (<span id="inactive-count">0</span>)
                </button>
            </div>
        </div>

        <div class="content" id="vouchers-list"></div>

        <div class="bottom-actions">
            <button class="action-btn" onclick="openCreateModal()">
                <svg><use href="#icon-circle-plus"></use></svg>צור שובר
            </button>
            <button class="action-btn" onclick="openSearchModal()">
                <svg><use href="#icon-search"></use></svg>חפש שובר
            </button>
            <button class="action-btn btn-more" onclick="openMoreModal()">
                עוד<svg><use href="#icon-ellipsis"></use></svg>
            </button>
        </div>
    </div>

    <!-- Create/Edit Modal -->
    <div class="modal-overlay" id="edit-modal">
        <div class="modal-card">
            <div class="modal-header">
                <h2 id="modal-title">יצירת שובר חדש</h2>
                <button class="modal-menu-btn hidden" id="voucher-menu-btn" onclick="toggleVoucherMenu(event)">
                    <svg style="transform: rotate(90deg);"><use href="#icon-ellipsis"></use></svg>
                    <div class="modal-menu-popup" id="voucher-menu-popup">
                        <div class="modal-menu-item" onclick="duplicateVoucher()">שכפל שובר</div>
                    </div>
                </button>
            </div>
            
            <div class="form-row">
                <div class="form-group in-row">
                    <label>שם</label>
                    <input type="text" id="voucher-name" placeholder="הקלד שם ...">
                </div>
                <div class="form-group value-group in-row">
                    <label>שווי</label>
                    <input type="text" id="voucher-value" placeholder="הקלד שווי ...">
                </div>
            </div>

            <div class="form-group">
                <label>קוד</label>
                <input type="text" id="voucher-code" placeholder="הקלד קוד שובר או קישור ...">
            </div>

            <div class="form-group">
                <label>תיאור</label>
                <textarea id="voucher-description" placeholder="הקלד תיאור ..."></textarea>
            </div>

            <div class="redemptions-box">
                <div class="redemption-input-row">
                    <input type="text" id="redemption-value" placeholder="הקלד ערך המימוש ...">
                    <button class="add-redemption-btn" onclick="addRedemption()">הוסף מימוש</button>
                </div>
                <div class="redemptions-list" id="redemptions-list"></div>
            </div>

            <div class="form-row">
                <div class="balance-box">
                    <span class="balance-label">יתרה</span>
                    <span class="balance-amount" id="balance">0.00 ₪</span>
                </div>
                <button class="modal-btn btn-mark-used" id="mark-used-btn" onclick="markAsUsed()">סמן כמומש</button>
            </div>

            <div class="button-row">
                <button class="modal-btn btn-save" onclick="saveVoucher()">שמור</button>
                <button class="modal-btn btn-delete" id="delete-btn" style="display:none" onclick="deleteVoucher()">מחק</button>
                <button class="modal-btn btn-cancel" onclick="closeEditModal()">ביטול</button>
            </div>
        </div>
    </div>

    <!-- Search Modal -->
    <div class="modal-overlay" id="search-modal">
        <div class="modal" onclick="event.stopPropagation()">
            <h2>חיפוש שובר</h2>
            
            <div class="form-group">
                <input type="text" id="search-input" placeholder="הקלד שם או תיאור..." oninput="performSearch()" style="background: rgba(139, 154, 139, 0.3); color: var(--clr-gry1);" />
            </div>

            <div class="search-results" id="search-results"></div>

            <button class="modal-btn btn-cancel" style="width:100%; margin-top: 20px;" onclick="closeSearchModal()">סגור</button>
        </div>
    </div>

    <!-- More Modal -->
    <div class="modal-overlay" id="more-modal">
        <div class="modal" onclick="event.stopPropagation()">
            <h2>עוד אפשרויות</h2>
            <div class="modal-more-actions">
                <button class="modal-btn action-btn" style="background: #B87C4C; color: white; display: flex; align-items: center; justify-content: space-between;" onclick="goBack()">
                    <svg style="width: 20px; height: 20px;"><use href="#icon-shopping-cart"></use></svg>
                    חזרה לרשימת קניות
                    <svg style="transform: rotate(180deg); width: 20px; height: 20px;"><use href="#icon-chevron-left"></use></svg>
                </button>
                <div class="action-group">
                    <button class="modal-btn" onclick="exportData()">ייצא נתונים</button>
                    <button class="modal-btn" onclick="importData()">ייבא נתונים</button>
                    <button class="modal-btn btn-delete" onclick="deleteAllData()">מחק הכל</button>
                </div>
                <button class="modal-btn btn-cancel" onclick="closeMoreModal()">ביטול</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- ##################################################################################### -->
    <!-- #####################################  Script   ##################################### -->
    <!-- ##################################################################################### -->
    <script>
        // Configuration - Vercel Serverless API
        const API_BASE = '/api';

        let vouchers = [];
        let showingActive = true;
        let editingVoucherId = null;
        let currentRedemptions = [];
        let currentIsRedeemed = false;
        let openedModal = null;
        const redeemedHtml = '<svg class="ban-icon"><use href="#icon-ban"></use></svg> מומש'

        // ==================== API Helper Functions ====================
        function showLoading() {
            document.getElementById('loading-overlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.remove('active');
        }

        async function apiRequest(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'שגיאה בתקשורת עם השרת');
                }

                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // ==================== Initialize ====================
        async function init() {
            await loadVouchers();
            renderVouchers();
        }

        // ==================== Storage Functions (Neon DB) ====================
        async function loadVouchers() {
            try {
                showLoading();
                vouchers = await apiRequest('/vouchers');
                hideLoading();
            } catch (error) {
                hideLoading();
                alert('שגיאה בטעינת השוברים: ' + error.message);
                vouchers = [];
            }
        }

        async function saveVoucherToDb(voucher) {
            if (editingVoucherId) {
                return await apiRequest(`/vouchers?id=${voucher.id}`, {
                    method: 'PUT',
                    body: JSON.stringify(voucher)
                });
            } else {
                return await apiRequest('/vouchers', {
                    method: 'POST',
                    body: JSON.stringify(voucher)
                });
            }
        }

        async function deleteVoucherFromDb(id) {
            return await apiRequest(`/vouchers?id=${id}`, {
                method: 'DELETE'
            });
        }

        async function deleteAllVouchersFromDb() {
            return await apiRequest('/vouchers?action=deleteAll', {
                method: 'DELETE'
            });
        }

        async function importVouchersToDb(vouchersData) {
            return await apiRequest('/vouchers?action=import', {
                method: 'POST',
                body: JSON.stringify(vouchersData)
            });
        }

        // ==================== Utility Functions ====================
        function parsDateTime() {
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            return {day, month, year, hours, minutes};
        }

        function calculateBalance(initialValue, redemptions) {
            const initial = parseFloat(initialValue) || 0;
            const total = redemptions.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
            return initial - total;
        }

        function updateBalanceDisplay() {
            const initialValue = document.getElementById('voucher-value').value;
            const balance = calculateBalance(initialValue, currentRedemptions);
            document.getElementById('balance').textContent = `${balance.toFixed(2)} ₪`;
            
            // Update mark as used button state based on current temporary state
            const markUsedBtn = document.getElementById('mark-used-btn');
            markUsedBtn.classList.toggle('used', currentIsRedeemed);
            if (currentIsRedeemed) {
                markUsedBtn.innerHTML = redeemedHtml;
            } else {
                markUsedBtn.innerHTML = 'סמן כמומש';
            }
        }

        // ==================== Render Functions ====================
        function renderVouchers() {
            const filtered = vouchers
                .filter(v => showingActive ? !v.isRedeemed : v.isRedeemed)
                .sort((a, b) => a.name.localeCompare(b.name, 'he'));
            
            const container = document.getElementById('vouchers-list');
            
            const isValidUrl = (str) => { try { new URL(str); return true; } catch { return false; } };

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state">אין שוברים ברשימה</div>';
            } else {
                container.innerHTML = filtered.map(v => {
                    const balance = calculateBalance(v.initialValue, v.redemptions);
                    let codeHtml = "";
                    if (isValidUrl(v.code)) {
                        codeHtml = `<a href="${v.code}" target="_blank" onclick="event.stopPropagation()">${v.code}</a>`;
                    } else {
                        codeHtml = `<span>${v.code || 'אין קוד'}</span>`;
                    }
                    return `
                        <div class="voucher-item ${v.isRedeemed ? 'redeemed' : ''}" onclick="openEditModal(${v.id})">
                            <div class="voucher-name">${v.name}</div>
                            <div class="voucher-balance">${balance.toFixed(2)} ₪</div>
                            ${v.isRedeemed ? '<span class="voucher-redeemed-badge">' + redeemedHtml + '</span>' : '<div></div>'}
                            <div class="voucher-code">${codeHtml}</div>
                        </div>
                    `;
                }).join('');
            }
            
            updateCounts();
        }

        function updateCounts() {
            document.getElementById('active-count').textContent = 
                vouchers.filter(v => !v.isRedeemed).length;
            document.getElementById('inactive-count').textContent = 
                vouchers.filter(v => v.isRedeemed).length;
        }

        function renderRedemptions() {
            const list = document.getElementById('redemptions-list');
            if (currentRedemptions.length === 0) {
                list.innerHTML = '';
                return;
            }
            
            list.innerHTML = currentRedemptions.map((r, index) => `
                <div class="redemption-item">
                    <button class="delete-btn" onclick="deleteRedemption(${index})">✕</button>
                    <span class="date">${r.date}</span>
                    <span class="amount">${parseFloat(r.amount).toFixed(2)} ₪</span>
                </div>
            `).join('');
        }

        // ==================== Actions ====================
        function showActiveVouchers(active) {
            showingActive = active;
            const tabs = document.querySelectorAll('.tab-btn');
            tabs[0].classList.toggle('active', active);
            tabs[1].classList.toggle('active', !active);
            renderVouchers();
        }

        function pushStateForModal(id) {
            history.pushState({ modalOpen: true }, '');
            openedModal = id;
        }

        function popStateOfModal() {
            if (openedModal) history.back();
            openedModal = null;
        }

        function openCreateModal() {
            editingVoucherId = null;
            currentRedemptions = [];
            currentIsRedeemed = false;
            document.getElementById('modal-title').textContent = 'יצירת שובר חדש';
            document.getElementById('voucher-name').value = '';
            document.getElementById('voucher-value').value = '';
            document.getElementById('voucher-code').value = '';
            document.getElementById('voucher-description').value = '';
            document.getElementById('redemption-value').value = '';
            document.getElementById('delete-btn').style.display = 'none';
            document.getElementById('voucher-menu-btn').classList.add('hidden');
            renderRedemptions();
            updateBalanceDisplay();
            document.getElementById('edit-modal').classList.add('active');
            pushStateForModal('edit-modal');
        }

        function openEditModal(id) {
            const voucher = vouchers.find(v => v.id === id);
            if (!voucher) return;
            
            editingVoucherId = id;
            currentRedemptions = [...voucher.redemptions];
            currentIsRedeemed = voucher.isRedeemed;
            document.getElementById('modal-title').textContent = 'עריכת שובר';
            document.getElementById('voucher-name').value = voucher.name;
            document.getElementById('voucher-value').value = voucher.initialValue;
            document.getElementById('voucher-code').value = voucher.code || '';
            document.getElementById('voucher-description').value = voucher.description || '';
            document.getElementById('redemption-value').value = '';
            document.getElementById('delete-btn').style.display = 'block';
            document.getElementById('voucher-menu-btn').classList.remove('hidden');
            
            renderRedemptions();
            updateBalanceDisplay();
            document.getElementById('edit-modal').classList.add('active');
            pushStateForModal('edit-modal');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('active');
            document.getElementById('voucher-menu-popup').classList.remove('active');
            popStateOfModal()
        }

        function toggleVoucherMenu(event) {
            event.stopPropagation();
            const popup = document.getElementById('voucher-menu-popup');
            popup.classList.toggle('active');
        }

        function duplicateVoucher() {
            // Get current voucher data
            const name = document.getElementById('voucher-name').value.trim();
            const description = document.getElementById('voucher-description').value.trim();

            // Close current modal and menu
            closeEditModal();

            // Open create modal with pre-filled data
            // TODO: improve this flow (without timeout, popStateOfModal issues)
            setTimeout(() => {
                openCreateModal();
                document.getElementById('voucher-name').value = name;
                document.getElementById('voucher-description').value = description;
            }, 200);
        }

        function addRedemption() {
            const input = document.getElementById('redemption-value');
            const value = input.value.trim();
            
            if (value === '') {
                alert('נא להזין ערך מימוש');
                return;
            }
            
            const numValue = parseFloat(value);
            if (isNaN(numValue) || numValue <= 0) {
                alert('נא להזין ערך מספרי חיובי');
                return;
            }

            const d = parsDateTime();
            currentRedemptions.unshift({
                amount: numValue,
                date: `${d.day}.${d.month}.${d.year} ${d.hours}:${d.minutes}`
            });
            
            input.value = '';
            renderRedemptions();
            updateBalanceDisplay();
        }

        function deleteRedemption(index) {
            currentRedemptions.splice(index, 1);
            renderRedemptions();
            updateBalanceDisplay();
        }

        function markAsUsed() {
            currentIsRedeemed = !currentIsRedeemed;
            updateBalanceDisplay();
        }

        async function saveVoucher() {
            const name = document.getElementById('voucher-name').value.trim();
            const value = document.getElementById('voucher-value').value.trim();
            
            if (!name || !value) {
                alert('נא למלא לפחות שם ושווי');
                return;
            }

            const numValue = parseFloat(value);
            if (isNaN(numValue) || numValue < 0) {
                alert('נא להזין ערך שווי תקין');
                return;
            }

            const voucher = {
                id: editingVoucherId || Date.now(),
                name: name,
                initialValue: numValue,
                code: document.getElementById('voucher-code').value.trim(),
                description: document.getElementById('voucher-description').value.trim(),
                redemptions: currentRedemptions,
                isRedeemed: currentIsRedeemed
            };

            try {
                showLoading();
                await saveVoucherToDb(voucher);
                await loadVouchers();
                hideLoading();
                closeEditModal();
                renderVouchers();
            } catch (error) {
                hideLoading();
                alert('שגיאה בשמירת השובר: ' + error.message);
            }
        }

        async function deleteVoucher() {
            if (!confirm('האם למחוק את השובר?')) return;
            
            try {
                showLoading();
                await deleteVoucherFromDb(editingVoucherId);
                await loadVouchers();
                hideLoading();
                closeEditModal();
                renderVouchers();
            } catch (error) {
                hideLoading();
                alert('שגיאה במחיקת השובר: ' + error.message);
            }
        }

        function openSearchModal() {
            document.getElementById('search-input').value = '';
            document.getElementById('search-results').innerHTML = 
                '<div class="empty-state">התחל להקליד לחיפוש שוברים</div>';
            document.getElementById('search-modal').classList.add('active');
            pushStateForModal('search-modal');
        }

        function closeSearchModal() {
            document.getElementById('search-modal').classList.remove('active');
            popStateOfModal()
        }

        function performSearch() {
            const query = document.getElementById('search-input').value.trim().toLowerCase();
            const resultsDiv = document.getElementById('search-results');
            
            if (!query) {
                resultsDiv.innerHTML = '<div class="empty-state">התחל להקליד לחיפוש שוברים</div>';
                return;
            }

            const filtered = vouchers.filter(v => 
                v.name.toLowerCase().includes(query) ||
                (v.description && v.description.toLowerCase().includes(query))
            ).sort((a, b) => a.name.localeCompare(b.name, 'he'));

            if (filtered.length === 0) {
                resultsDiv.innerHTML = '<div class="empty-state">לא נמצאו שוברים</div>';
                return;
            }

            resultsDiv.innerHTML = filtered.map(v => {
                const balance = calculateBalance(v.initialValue, v.redemptions);
                return `
                    <div class="voucher-item ${v.isRedeemed ? 'redeemed' : ''}" onclick="openEditModal(${v.id}); closeSearchModal();">
                        <div class="voucher-name">${v.name}</div>
                        <div class="voucher-balance">${balance.toFixed(2)} ₪</div>
                        ${v.isRedeemed ? '<span class="voucher-redeemed-badge">' + redeemedHtml + '</span>' : '<div></div>'}
                        <div class="voucher-code">${v.code || 'אין קוד'}</div>
                    </div>
                `;
            }).join('');
        }

        function openMoreModal() {
            document.getElementById('more-modal').classList.add('active');
            pushStateForModal('more-modal');
        }

        function closeMoreModal() {
            document.getElementById('more-modal').classList.remove('active');
            popStateOfModal()
        }

        async function exportData() {
            try {
                showLoading();
                await loadVouchers();
                hideLoading();

                const data = JSON.stringify(vouchers, null, 2);
                const blob = new Blob([data], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const d = parsDateTime();
                const filename = `vouchers-${d.year}${d.month}${d.day}_${d.hours}${d.minutes}.json`;
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
                closeMoreModal();
            } catch (error) {
                hideLoading();
                alert('שגיאה בייצוא הנתונים: ' + error.message);
            }
        }

        async function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async e => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async event => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        if (Array.isArray(imported)) {
                            showLoading();
                            await importVouchersToDb(imported);
                            await loadVouchers();
                            hideLoading();
                            renderVouchers();
                            closeMoreModal();
                        } else {
                            alert('קובץ לא תקין');
                        }
                    } catch (error) {
                        hideLoading();
                        alert('שגיאה בייבוא הנתונים: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        async function deleteAllData() {
            if (confirm('האם למחוק את כל השוברים? פעולה זו לא ניתנת לביטול!')) {
                try {
                    showLoading();
                    await deleteAllVouchersFromDb();
                    await loadVouchers();
                    hideLoading();
                    renderVouchers();
                    closeMoreModal();
                } catch (error) {
                    hideLoading();
                    alert('שגיאה במחיקת הנתונים: ' + error.message);
                }
            }
        }

        function goBack() {
            window.location.href = "index.html";
        }

        // ==================== Event Listeners ====================
        // Close modals on overlay click
        document.getElementById('search-modal').onclick = closeSearchModal;
        document.getElementById('more-modal').onclick = closeMoreModal;

        // Close voucher menu when clicking outside
        document.addEventListener('click', function(event) {
            const menuPopup = document.getElementById('voucher-menu-popup');
            const menuBtn = document.getElementById('voucher-menu-btn');
            if (menuPopup && !menuPopup.contains(event.target) && !menuBtn.contains(event.target)) {
                menuPopup.classList.remove('active');
            }
        });

        document.getElementById('voucher-value').addEventListener('input', updateBalanceDisplay);
        document.getElementById('redemption-value').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addRedemption();
            }
        });

        window.addEventListener('popstate', (event) => {
            if (openedModal)
                document.getElementById(openedModal).classList.remove('active');
            openedModal = null;
        });

        // ==================== Initialize App ====================
        init();
    </script>
</body>
</html>